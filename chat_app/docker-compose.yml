services:
  web:
    container_name: "chat-web"
    build: .
    ports:
      - "8000:8000"
    depends_on:
      - rabbitmq
      - db
      - redis
    environment:
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
    restart: always
    volumes:
      - .:/code/app

  rabbitmq:
    container_name: "chat-rabbitmq"
    image: "rabbitmq:3.12-management-alpine"
    ports:
      - "15672:15672"
      - "5672:5672"
    hostname: rabbitmq
    restart: always
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s      # how often to run check
      timeout: 5s        # time allowed for the check
      retries: 5         # how many failures before unhealthy
      start_period: 10s  # grace period before starting checks

  redis:
    container_name: "chat_redis"
    image: "redis:latest"
    ports:
      - "6379:6379"
    
  db:
    container_name: "chat-mongo"
    image: "mongo:latest"
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db


volumes:
  mongo_data:
